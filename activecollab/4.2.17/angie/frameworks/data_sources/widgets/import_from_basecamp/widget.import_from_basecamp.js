jQuery.fn.importFromBasecamp=function(s){var settings=jQuery.extend({validate_url:null},s);return this.each(function(){var wrapper=$(this);var queue=[];var running=false;var close_btn=$("div#data_sources_import #data_sources_importer_close_btn");var close_x=$("a.flyout_dialog_close_button");var working=$('<span><img src="'+App.Wireframe.Utils.indicatorUrl()+'">'+App.lang(" Importing...")+"</span>");var checking=$('<span><img src="'+App.Wireframe.Utils.indicatorUrl()+'">'+App.lang(" Checking...")+"</span>");var queued=$("<span>Queued...</span>");var imported=$('<span><img src="'+App.Wireframe.Utils.indicatorUrl("ok")+'">'+App.lang(" Imported")+"</span>");var cant_import=$('<span><img src="'+App.Wireframe.Utils.indicatorUrl("error")+'">'+App.lang(" Can't import")+"</span>");var import_btns=wrapper.find("button");import_btns.click(function(event){var button=$(this);var action=button.attr("action");var project_id=button.attr("project_id");var step={url:button.attr("step_url"),action:action,project_id:project_id};var button_container=$("div#button_holder_"+project_id);button_container.html(queued.html());queue.push(step);close_btn.hide();close_x.hide();if(!running){validate_before_import(0)}event.preventDefault();return false});var execute_step=function(step_num){var step=queue[step_num];running=true;var button_container=$("div#button_holder_"+step.project_id);button_container.html(working.html());$.ajax({url:step.url,type:"post",data:{submitted:"submitted",params:{action:step.action,project_id:step.project_id}},success:function(response){running=false;button_container.html(imported.html());var next_step=step_num+1;if(next_step<queue.length){validate_before_import(next_step)}else{queue=[];close_btn.show();close_x.show()}},error:function(response){button_container.html('<span><img src="'+App.Wireframe.Utils.indicatorUrl("error")+'"> '+App.Wireframe.Utils.responseToErrorMessage(response)+"</span>");running=false;queue=[]}})};var validate_before_import=function(step_num){var step=queue[step_num];running=true;var button_container=$("div#button_holder_"+step.project_id);button_container.html(checking.html());$.ajax({url:settings.validate_url,type:"post",data:{submitted:"submitted",params:{action:step.action,project_id:step.project_id}},success:function(response){if(response===true){execute_step(step_num)}else{if(response.is_valid===false){button_container.html(cant_import.html());App.Wireframe.Flash.error(response.message);var next_step=step_num+1;if(next_step<queue.length){validate_before_import(next_step)}else{queue=[];running=false;close_btn.show();close_x.show()}}}}})}})};